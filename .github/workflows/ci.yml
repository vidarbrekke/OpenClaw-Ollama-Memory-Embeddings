name: CI

on:
  push:
  pull_request:

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Run shellcheck
        run: shellcheck dist/install.sh dist/verify.sh dist/enforce.sh dist/watchdog.sh dist/audit.sh tests/smoke/smoke_install_with_mock.sh tests/smoke/smoke_lock_contention.sh tests/smoke/smoke_log_prefix.sh tests/smoke/smoke_audit.sh

  node-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Run Node unit tests
        run: node --test tests/unit/*.test.js

  smoke-install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Run install smoke with mocked Ollama
        run: bash tests/smoke/smoke_install_with_mock.sh
      - name: Run lock contention smoke
        run: bash tests/smoke/smoke_lock_contention.sh
      - name: Run log prefix smoke
        run: bash tests/smoke/smoke_log_prefix.sh
      - name: Run audit smoke
        run: bash tests/smoke/smoke_audit.sh
